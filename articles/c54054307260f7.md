---
title: "WindowsでTrustedInstallerに昇格する(トークン偽装)"
emoji: "🦔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["セキュリティ", "windows", "cpp"]
published: false
---

Windowsの最高権限であるTrustedInstaller権限でプロセスを起動する方法とコードを備忘録として残します。
また、以下に残す方法は一般ユーザーが保持していない"SeImpersonatePrivilege"と"SeDebugPrivilege"権限が必要です。
一般ユーザーがいきなりTrustedInstallerに昇格するようなものではありません。
あくまで、Administratorが実行する前提になります。

## 前提知識の解説

### Windowsの権限管理の仕組み

Windowsのプロセスの権限管理にアクセストークンという仕組みを使用しています。
各プロセスは権限情報を表すトークンが紐づけられ

## 昇格までの流れ

1. SYSTEM権限で起動しているプロセスからアクセストークンを複製
1. 現在のプロセスに複製したアクセストークンを付与
1. SYSTEM権限でTrustedInstaller.exeを起動する。
1. 起動したTrustedInstaller.exeのアクセストークンを複製
1. 複製したアクセストークンを付与した新しいプロセスを起動する。
1. プロセスがTrustedInstaller権限で起動する。

## SYSTEM権限で起動しているプロセスからアクセストークンを複製

Windowsのログオン機能をつかさどるwinlogon.exeはSYSTEM権限で起動されています。
そのため、winlogon.exeにはSYSTEM権限のアクセストークンが紐づけられています。
以下関数を利用してwinlogon.exeのアクセストークンを偽装トークン(TokenImpersonation)としてコピーします。
そのあと複製した偽装トークンを現在のプロセスに割り当てます。

```cpp
 // winlogon.exeのプロセスのハンドルを取得。(pidはwinlogon.exeのプロセスID)
 HANDLE hProcessWinlogon = OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION, TRUE, pid);
 // winlogon.exeのプロセスハンドルからアクセストークンのハンドルを取得
 HANDLE hTokenWinlogon;
 OpenProcessToken(hProcessWinlogon, TOKEN_ASSIGN_PRIMARY | TOKEN_DUPLICATE | TOKEN_IMPERSONATE | TOKEN_QUERY, &hTokenWinlogon); 
 //DuplicateProcessToken関数を使用してして偽装トークンとして複製し、ハンドルを取得。
 HANDLE hImpersonationToken;
 DuplicateTokenEx(hTokenWinlogon, MAXIMUM_ALLOWED, NULL, SecurityImpersonation, TOKEN_TYPE::TokenImpersonation, &hImpersonationToken)
 // 現在のプロセスのハンドルを取得
 HANDLE hCurrentThread = GetCurrentThread();
 // 複製したアクセストークンを現在のスレッドに割り当てる。
 SetThreadToken(&hCurrentThread, hImpersonationToken);
```

## 参考記事

<https://book.hacktricks.xyz/v/jp/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens>
<https://blog.nflabs.jp/entry/2021/12/20/094644>
