---
title: "WindowsでTrustedInstallerに昇格する(トークン偽装)"
emoji: "🦔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["セキュリティ", "windows", "cpp"]
published: false
---

Windowsの最高権限であるTrustedInstaller権限でプロセスを起動する方法とコードを備忘録として残します。
また、以下に残す方法は一般ユーザーが保持していない"SeImpersonatePrivilege"と"SeDebugPrivilege"権限が必要です。
一般ユーザーがいきなりTrustedInstallerに昇格するようなものではありません。
あくまで、Administratorが実行する前提になります。

## 前提知識の解説

### Windowsの権限管理の仕組み

## 昇格までの流れ

1. SYSTEM権限で起動しているプロセスからアクセストークンを複製
1. 現在のプロセスに複製したアクセストークンを付与
1. SYSTEM権限でTrustedInstaller.exeを起動する。
1. 起動したTrustedInstaller.exeのアクセストークンを複製
1. 複製したアクセストークンを付与した新しいプロセスを起動する。
1. プロセスがTrustedInstaller権限で起動する。

## 参考記事

<https://book.hacktricks.xyz/v/jp/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens>
<https://blog.nflabs.jp/entry/2021/12/20/094644>
